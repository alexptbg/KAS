<?php
defined('start') or die('Direct access not allowed.');
//start
if ((isset($_POST['submit'])) && (isset($_POST['hash'])) && (isset($_POST['code'])) && (isset($_POST['lkey']))) {
						    	$uid = mysql_prep($_POST['id']);
	                            $hash = $_POST['hash'];
	                            $code = $_POST['code'];
	                            $lkey = $_POST['lkey'];
	                            if (($hash != "") && ($code != "") && ($lkey != "")) {
	                                mysql_query("SET NAMES utf8");
		                            $query = "UPDATE `settings` SET `hash`='".$hash."', `code`='".$code."', `lkey`='".$lkey."' WHERE `id`='".$uid."' LIMIT 1";
                                    $result = mysql_query($query);
                                    confirm_query($result);
                                    if ($result) {
										//updated successfully
										echo "</div>";
										//end of top header
                                        echo "<div id=\"page-wrapper\">
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">
                                                          <h3 class=\"page-header text-asbestos\"><i class=\"fa fa-key\"></i>&nbsp;".get_lang($lang,'k217')."</h3>
                                                      </div>
                                                  </div>
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">";
                                        echo "<div class=\"panel panel-danger\">";
                                        echo "<div class=\"panel-heading\">
                                                  ".get_lang($lang,'k237')."
                                              </div>";
										echo "<div class=\"panel-body\"><div class=\"alert alert-success\">";
                                        echo get_lang($lang, 'k238');
                                        echo "</div></div></div></div></div></div>";
				                        $url = "index.php?lang=".$lang;
				                        redir($url,'2');
                                    } else {
									    //error with update
                                        echo "<div id=\"page-wrapper\">
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">
                                                          <h3 class=\"page-header text-asbestos\"><i class=\"fa fa-key\"></i>&nbsp;".get_lang($lang,'k217')."</h3>
                                                      </div>
                                                  </div>
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">";
                                        echo "<div class=\"panel panel-danger\">";
                                        echo "<div class=\"panel-heading\">
                                                  ".get_lang($lang,'k237')."
                                              </div>";
										echo "<div class=\"panel-body\"><div class=\"alert alert-danger\">";
                                        echo get_lang($lang,'k239');
                                        echo "</div></div>";
										echo "<div class=\"panel-footer\">";
                                        echo "<button type=\"button\" class=\"btn btn-primary btn-lg\" onClick=\"javascript: history.go(-1); return false;\"><i class=\"fa fa-arrow-left\"></i>&nbsp;".get_lang($lang,'k34')."</button>";
                                        echo "</div></div></div></div></div>";
									}
								} else {
									//error //not submited
                                        echo "<div id=\"page-wrapper\">
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">
                                                          <h3 class=\"page-header text-asbestos\"><i class=\"fa fa-key\"></i>&nbsp;".get_lang($lang,'k217')."</h3>
                                                      </div>
                                                  </div>
                                                  <div class=\"row\">
                                                      <div class=\"col-lg-12\">";
                                    echo "<div class=\"panel panel-danger\">";
                                    echo "<div class=\"panel-heading\">
                                              ".get_lang($lang,'k236')."
                                          </div>";
									echo "<div class=\"panel-body\"><div class=\"alert alert-danger\">";
                                    echo get_lang($lang,'k33');
                                    echo "</div></div>";
								    echo "<div class=\"panel-footer\">";
                                    echo "<button type=\"button\" class=\"btn btn-primary btn-lg\" onClick=\"javascript: history.go(-1); return false;\"><i class=\"fa fa-arrow-left\"></i>&nbsp;".get_lang($lang,'k34')."</button>";
                                    echo "</div></div></div></div></div>";
								}
								die;
} else {
$_x = $settings['salt'];
$_s = strtotime(decrypt($settings['hash'],$_x));
$_e = strtotime(decrypt($settings['code'],$_x));
$_k = decrypt($settings['lkey'],$_x);
$_n = date('Y-m-d');
$_n = strtotime($_n);
$_d = constant('HOST');
$_c = get_domain($_d);
$_v = date('Y-m-d',$_s);
$_t = date('Y-m-d',$_e);
if ($installed>$_s) {
    $_z = date('Y-m-d',$installed);
    $end = date('Y-m-d',strtotime("$_z +30 days"));
	$_ex = strtotime($end);
    $now = strtotime(date('Y-m-d'));
    $datediff = $_ex - $now;
    $days = floor($datediff/(60*60*24));
	$stop = strtotime($end);
	$_z = date('Y-m-d',$end);
	if ($_c != $_k) {
	    if (($days<30) && ($days>0)) {
	        //trial version before activate
            echo "<span class=\"text-danger\">You are using a trial version, you have ".$days." to activate your license.</span>";
	    } else {
	        //trial ended after 30 days test
	        echo "<span class=\"text-danger\">trial ended at ".$end.". </span>
	              <span class=\"text-danger\">".get_lang($lang,'k228')."</span>";
	    }
	}
} else {
    if ($_c == $_k) {
        if (($_n>$_s) and ($_n<$_e)) {
	        $end = $_e;
	        $now = strtotime(date('Y-m-d'));
	        $datediff = $end - $now;
            $days = floor($datediff/(60*60*24));
            //working serial
			if ($days<30){
			    //last 30 days
				//echo "<span class=\"text-danger\">".$days."</span></td>";
			} else {
				//more than 30 days ahead to work, everything it's fine'
				//echo "<span class=\"text-success\">".$days."</span></td> ";
			}                      
	    } else {
		    $_z = date('Y-m-d',$_e);
	        $now = strtotime(date('Y-m-d'));
			$_i = strtotime(date('Y-m-d',$installed));
	        $datediff = $now - $_e;
            $days = floor($datediff/(60*60*24));
            $stop = date('Y-m-d', strtotime("$_z +30 days") );
			if (($days<30) && ($days>0)) {
			    echo "</div>";
			    //end of top header
			    echo "
                <div class=\"col-lg-12\">
                    <div class=\"alert alert-danger\" style=\"width:50%;margin:0 auto;margin-top:20px;\">
                        <span>".get_lang($lang,'k244')."&nbsp;<strong>".$_z."</strong>.&nbsp;".$settings['slogan']." ".get_lang($lang,'k232')."&nbsp;
                            <strong>".$stop."</strong>.</span>
                    </div>
                    <div class=\"alert alert-warning\" style=\"width:50%;margin:0 auto;margin-top:20px;\">
                        <span>".get_lang($lang,'k245')."</span>";
                        if ($user_settings['level'] > 20) { 
                            echo "<span>&nbsp;<strong><a href=\"\" style=\"color:#FFF;text-transform:uppercase;\" />".get_lang($lang,'k246')."</strong></span>"; 
                        } else {
							echo "<span>&nbsp;".get_lang($lang,'k247')."</span>";
						}
              echo "</div>
                </div>
			    ";
		    } else {
        echo "</div>";
        //end of top header
        echo "<div id=\"page-wrapper\">
                <div class=\"row\">
                    <div class=\"col-lg-12\">
                        <h3 class=\"page-header text-asbestos\"><i class=\"fa fa-key\"></i>&nbsp;".get_lang($lang,'k217')."</h3>
                    </div>
                </div>
                <div class=\"alert alert-danger\">
                    <span>".$settings['slogan']." ".get_lang($lang,'k233')." <strong>".$stop."</strong>.</span>
                </div>
                <div class=\"row\">";
                echo "
                    <div class=\"col-lg-6\">
                        <div class=\"panel panel-danger\">
                            <div class=\"panel-heading\">
                                ".get_lang($lang,'k236')."
                            </div>
                            <form method=\"POST\" action=\"\" id=\"forms\">
                            <div class=\"panel-body\">
                                <div class=\"form-group\">
                                    <input class=\"form-control\" type=\"hidden\" name=\"id\" value=\"".$settings['id']."\" readonly=\"readonly\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k213').":</label>
                                    <input class=\"form-control\" type=\"text\" name=\"host\" value=\"".HOST."\" readonly=\"readonly\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k214').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"32\" type=\"text\" name=\"hash\" value=\"".$settings['hash']."\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k215').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"32\" type=\"text\" name=\"code\" value=\"".$settings['code']."\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k216').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"64\" type=\"text\" name=\"lkey\" value=\"".$settings['lkey']."\" />
                                </div>
                            </div>
                            <div class=\"panel-footer\">";
                                if ($user_settings['level'] > 20) { 
                                    echo "
								<button type=\"submit\" name=\"submit\" class=\"btn btn-danger btn-lg\">
								    <i class=\"fa fa-save\"></i>&nbsp;".get_lang($lang,'k29')."</button>
                                    ";
                                } else {
                                	echo "<p class=\"text-danger\">".get_lang($lang,'k247')."</p>";
									echo "
								<button type=\"submit\" name=\"submit\" class=\"btn btn-danger btn-lg\" disabled=\"disabled\">
								    <i class=\"fa fa-save\"></i>&nbsp;".get_lang($lang,'k29')."</button>
									";
								}
                      echo "</div>
                            </form>
                        </div>
                    </div>
                    <div class=\"col-lg-6\">
                        <div class=\"panel panel-danger\">
                            <div class=\"panel-heading\">
							    ".get_lang($lang,'k212')."
							</div>
                            <div class=\"panel-body\">
                                <div class=\"table-responsive\">
                                    <table class=\"table table-striped table-bordered\">
                                        <tbody>
                                            <tr>                                    
                                                <td style=\"text-align: right; width: 50%;\">".get_lang($lang,'k212').":</td>
                                                <td><span class=\"text-danger\">".get_lang($lang,'k229')."</span></td>                                   
                                            </tr>
                                            <tr>                                    
                                                <td style=\"text-align: right; width: 50%;\">".get_lang($lang,'k230').":</td>
                                                <td><span class=\"text-danger\">".$_z."</span></td>                                   
                                            </tr>
                                            <tr>                                    
                                                <td style=\"text-align: right; width: 50%;\">".get_lang($lang,'k231').":</td>
					                            <td><span class=\"text-danger\">".$days."</span></td>
                                            </tr>
				                        </tbody>
			                        </table>
                                </div>
                            </div>
                        </div>
                    </div>";
		        die;
			}
	    }
    } else {
        echo "</div>";
        //end of top header
        echo "<div id=\"page-wrapper\">
                <div class=\"row\">
                    <div class=\"col-lg-12\">
                        <h3 class=\"page-header text-asbestos\"><i class=\"fa fa-key\"></i>&nbsp;".get_lang($lang,'k217')."</h3>
                    </div>
                </div>
                <div class=\"row\">
                    <div class=\"col-lg-6\">
                        <div class=\"panel panel-danger\">
                            <div class=\"panel-heading\">
                                ".get_lang($lang,'k236')."
                            </div>
                            <form method=\"POST\" action=\"\" id=\"forms\">
                            <div class=\"panel-body\">
                                <div class=\"form-group\">
                                    <input class=\"form-control\" type=\"hidden\" name=\"id\" value=\"".$settings['id']."\" readonly=\"readonly\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k213').":</label>
                                    <input class=\"form-control\" type=\"text\" name=\"host\" value=\"".HOST."\" readonly=\"readonly\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k214').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"32\" type=\"text\" name=\"hash\" value=\"".$settings['hash']."\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k215').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"32\" type=\"text\" name=\"code\" value=\"".$settings['code']."\" />
                                </div>
                                <div class=\"form-group\">
                                    <label>".get_lang($lang,'k216').":</label>
                                    <input class=\"form-control validate[required]\" maxlength=\"64\" type=\"text\" name=\"lkey\" value=\"".$settings['lkey']."\" />
                                </div>
                            </div>
                            <div class=\"panel-footer\">
								<button type=\"submit\" name=\"submit\" class=\"btn btn-danger btn-lg\">
								    <i class=\"fa fa-save\"></i>&nbsp;".get_lang($lang,'k29')."</button>
                            </div>
                            </form>
                        </div>
                    </div>
                    <div class=\"col-lg-6\">
                        <div class=\"panel panel-danger\">
                            <div class=\"panel-heading\">
							    ".get_lang($lang,'k212')."
							</div>
                            <div class=\"panel-body\">
                                <div class=\"table-responsive\">
                                    <table class=\"table table-striped table-bordered\">
                                        <tbody>
                                            <tr>
                                                <td style=\"text-align: right; width: 40%;\">".get_lang($lang,'k222').":</td>
				                                <td>".$settings['installed']."</td>
					                        </tr>
                                            <tr>                                    
                                                <td style=\"text-align: right; width: 40%;\">".get_lang($lang,'k212').":</td>
                                                <td><span class=\"text-danger\">".get_lang($lang,'k234')."</span></td>                                   
                                            </tr>
                                            <tr>                                    
					                            <td colspan=\"2\" style=\"text-align:center;\">
					                                <span class=\"text-danger\">".$settings['slogan']." ".get_lang($lang,'k235')." </span>
					                            </td>
                                            </tr>
				                        </tbody>
			                        </table>
                                </div>
                            </div>
                        </div>
                    </div>";
                die;
        }
    }
}
?>